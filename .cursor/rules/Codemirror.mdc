---
alwaysApply: true
---

# CodeMirror Forge Development Rules

## CodeMirror Implementation Guidelines

### CodeMirror 5 Structure
- This project uses **CodeMirror 5** (not CodeMirror 6)
- CodeMirror instances are accessed via `.CodeMirror` or `.CodeMirror-wrap` classes
- CodeMirror instance is available as `editorElement.CodeMirror` or `editorElement.cm`
- Settings are passed via `wp_localize_script` as `cmForgeSettings` object

### Editor Customization Pattern
When adding new editor customizations:

1. **Settings Registration** (`includes/class-cm-forge-admin.php`):
   - Add field registration in `register_settings()` method
   - Add sanitization in `sanitize_settings()` method
   - Add render method (e.g., `render_letter_spacing_field()`)

2. **Settings Passing** (`includes/class-cm-forge-editor.php`):
   - Add setting to `wp_localize_script` array in `enqueue_editor_assets()` method
   - Use camelCase for JavaScript property names (e.g., `letterSpacing`)

3. **Editor Application** (`assets/js/editor.js`):
   - Add customization logic in `customizeEditor()` function
   - Apply to code elements: `.CodeMirror-code`, `.CodeMirror pre`, `.CodeMirror-line`
   - **Exclude gutters**: Never apply styling to `.CodeMirror-gutters`, `.CodeMirror-gutter`, or `.CodeMirror-linenumber`
   - Explicitly reset gutter styles if needed

4. **Admin Preview** (`assets/js/admin.js`):
   - Add setting retrieval in `updatePreviewEditor()` function
   - Add application logic matching `editor.js` pattern
   - Add input to `settingsInputs` array for real-time updates
   - For text inputs (like line height), add `input` event listener

5. **CSS Styling** (`assets/css/editor.css`):
   - Add styles for editor elements
   - Always exclude gutters from custom styling
   - Use `!important` sparingly, only when necessary

### Gutter Handling Rules
- **Never apply** font-family, font-weight, font-size, letter-spacing, or line-height to gutter elements
- Always explicitly reset gutter styles: `.CodeMirror-gutters`, `.CodeMirror-gutter`, `.CodeMirror-linenumber`
- Gutter spacing adjustments should use padding/margin, not letter-spacing

### Real-time Preview Updates
- Number inputs: Automatically get both `change` and `input` events
- Text inputs: Must explicitly add `input` event listener (e.g., line height, letter spacing)
- Add all new inputs to `settingsInputs` array in `admin.js`

## Documentation Requirements

### After Every Change
**MANDATORY**: After making any code changes, you MUST update:

1. **README.md**:
   - Add new features to the "Features" section
   - Update the "Usage" section if new settings are added
   - Keep feature descriptions concise and user-friendly

2. **CHANGELOG.md**:
   - Add entries under appropriate version section
   - Use semantic versioning:
     - **MAJOR** (x.0.0): Breaking changes
     - **MINOR** (x.y.0): New features (backward compatible)
     - **PATCH** (x.y.z): Bug fixes only
   - Categorize changes:
     - `### Added` - New features
     - `### Changed` - Changes to existing features
     - `### Fixed` - Bug fixes
     - `### Removed` - Removed features
   - Update version links at the bottom of the file

### Changelog Format
- Follow [Keep a Changelog](https://keepachangelog.com/en/1.0.0/) format
- Use ISO date format (YYYY-MM-DD)
- Include compare links for versions
- Keep "Unreleased" section for work in progress

### Version Bumping Guidelines
- **New feature** (like letter spacing) → MINOR version (1.1.0)
- **Bug fix only** → PATCH version (1.0.1)
- **Breaking change** → MAJOR version (2.0.0)

### Version Number Updates
**MANDATORY**: After updating CHANGELOG.md with a new version, you MUST update the version number in ALL of the following files:

1. **`codemirror-forge.php`**:
   - Update `* Version: X.X.X` in the plugin header (line 6)
   - Update `define('CM_FORGE_VERSION', 'X.X.X');` constant (line 20)
   - Both must match the version in CHANGELOG.md

2. **`package.json`**:
   - Update `"version": "X.X.X"` field (line 3)
   - Must match the version in CHANGELOG.md

3. **Translation files** (automatic):
   - POT file version is automatically updated by the i18n script when you run `bun run i18n:lang <locale> all`
   - No manual update needed for translation files

**Important**: All version numbers must be identical across all files and match the version in CHANGELOG.md.

### Translation Updates
**MANDATORY**: After adding new translatable strings (using `__()`, `esc_html__()`, `esc_html_e()`, etc.), you MUST update translation files:

1. **NEVER manually edit** `.pot`, `.po`, or `.mo` files directly
2. **ALWAYS use** the i18n script: `bun run i18n:lang <locale> all`
3. **Update all languages** that have translations:
   - For Greek: `bun run i18n:lang el_GR all`
   - For English (US): `bun run i18n:lang en_US all`
4. **Requirements**: wp-env must be running (`bun run start`) before running i18n scripts
5. The script will:
   - Generate/update POT template from source code
   - Update PO files with new strings
   - Compile MO files from PO files
6. **Translation workflow**: The script automatically extracts all translatable strings from PHP files and updates translation files accordingly

## Code Style

### PHP
- Follow WordPress coding standards
- Use proper sanitization for all user inputs
- Use `esc_attr()`, `esc_html()` for output
- Register settings with proper sanitize callbacks

### JavaScript
- Use vanilla JavaScript (no jQuery dependencies for core functionality)
- Use `'use strict'` mode
- Check for undefined before accessing objects
- Use descriptive function and variable names

### CSS
- Use meaningful class names with `cm-forge-` prefix for custom classes
- Avoid `!important` unless absolutely necessary
- Always consider gutter exclusion in styles

## File Structure
- `includes/class-cm-forge-admin.php` - Admin settings and UI
- `includes/class-cm-forge-editor.php` - Editor asset enqueuing and settings passing
- `assets/js/editor.js` - Main editor customization logic
- `assets/js/admin.js` - Admin preview editor logic
- `assets/css/editor.css` - Editor styling (excludes gutters from custom styles)
